[[crowd]]
== Atlassian Crowd Support

{inrmonly}

https://www.atlassian.com/software/crowd[Atlassian Crowd] is a single sign-on and identity management product
that many organizations use to consolidate user accounts and control which users and groups have access to which
applications. Atlassian Crowd support is an feature preinstalled and ready to configure in {pro}. {nxrm}
contains a security realm that allows you to configure the repository manager to authenticate against an Atlassian
Crowd instance.

WARNING: *Using LDAP and Crowd Realms together in the repository manager may work, but this is not supported.*
If you already use LDAP support, we recommend adding your LDAP server as a Crowd directory accessible to the Crowd
application instead of using both LDAP and Crowd realms in the repository manager.

[[crowd-application-prepare]]
=== Prepare Atlassian Crowd

[[crowd-compatibility]]
==== Compatibility

Always use the latest version of Crowd available at the time your version of {pro} was installed or upgraded. 
If upgrading to a newer Crowd server, carefully review the Crowd server release notes for REST API backwards 
compatibility issues.

Crowd support in {pro} only works in Crowd versions that support the Crowd REST API. Older versions use a 
deprecated SOAP-based API and are less reliable and performant.

Crowd support is actively tested with the highest available version of Crowd at the time {pro} is released.

[[crowd-setup]]
==== Add New Application to the Atlassian Crowd Server

NOTE: These instructions are a general guide to adding an application to Crowd. For current detailed 
instructions, visit the https://confluence.atlassian.com/display/CROWD/Adding+an+Application[official
Crowd documentation].

To connect {pro} to Crowd, you will need to configure {pro} as an application in Crowd.

* Login to Crowd as a user with administrative rights.
* Click on the 'Applications' tab.
* Click 'Add application' to display a form, shown in <<fig-crowd-add-application>>

Next, create the new application with the following values in the 'Details' section:

* Application Type
* Name
* Description

'Description' is optional. Choose a password for the application. The repository manager will use this 
password to authenticate with the Crowd server. Confirm the password, then click the 'Next' button to fill out 
'Connection'.

[[fig-crowd-add-application]]
.Adding a New Crowd Application
image::figs/web/crowd-add-application.png[scale=50]

On the 'Connection' screen provide the URL and the remote IP address for your repository manager application. You 
can click 'Resolve IP Address', which prompts Crowd to resolve the IP address for your application.

Once you have completed the 'Connection' form, click on 'Next' to advance to the 'Directories' form. The 
'Directories' form allows you to select the user directory used for authentication.

Click 'Next' to advance to the 'Authorisation' form. If any of the directories selected in the previous form 
contain groups, each group is displayed in a dropdown menu. You can check the 'Allow all users to 
authenticate' box above the dropdown within the directory, or you can select specific groups that are allowed to 
authenticate to {pro} via Crowd. This option would be used if you wanted to limit repository manager access to 
specific sub-groups within a larger Crowd directory. If your entire organization is stored in a single Crowd 
directory, you may want to limit repository manager access to a group that contains only developers and 
administrators. 

Click 'Next' to advance to the final screen, 'Confirmation', which gives you a summary of your Crowd server 
settings. Click 'Add application' to confirm the settings.

[[crowd-configuration]]
=== Configure {pro} Crowd Integration

[[crowd-capability]]
===== Enable the Crowd Capability

To enable 'Crowd' perform the following steps:

* Select 'Capabilities' to open the 'Capabilities' panel, located in the 'Administration' menu
* Click the 'Create capability' button to get to the 'Select Capability Type' table
* Select 'Crowd' to open the 'Create Crowd Capability' panel
* Complete the form by checking the 'Enable this capability', entering the 'Crowd Server URL', and identifying 
the 'Application Name' and 'Application Password' that corresponds to your Crowd application.

This form also includes an option to 'Use the Nexus truststore'. You would check this box if you configured and 
want to manage Crowd with the HTTPS protocol, mentioned in <<crowd-ssl>>.

After you enable the capability, you will see the 'Enable Crowd' box checked automatically in the 'Atlassian 
Crowd' panel. Further, you can see the resolved 'Crowd server URL', 'Crowd application name', and 'Crowd 
application password' all automatically filled in, as well. Additionally, you can configure 'Connection 
timeout', where you can enter a value that specifies the number of milliseconds the repository manager will wait 
for a response from Crowd. A value of zero indicates that there is no timeout limit. Leave the field blank to use 
the default timeout.

You can use the 'Verify Connection' button to confirm your connection to Crowd is working. Pressing 'Save' will 
save any changes made to the Crowd configuration, as shown in <<fig-manage-crowd-config>>.

[[fig-manage-crowd-config]]
.Crowd Configuration Panel
image::figs/web/manage-crowd-config.png[scale=50]

[[crowd-ssl]]
==== Configure {pro} to Trust Crowdâ€™s Secure URL (Optional)

Although optional, we advise the connection from {pro} to your Crowd server to use the HTTPS protocol.

If the Crowd certificate is not signed by a public certificate authority, you may have to explicitly trust
the server certificate as explained in <<ssl-proxy-repo>>. A common symptom observed is the +peer not 
authenticated+ message, when trying to connect to the untrusted Crowd server.

[[crowd-ssl-trust]]
===== Adding the Crowd Server Certificate to the Truststore

In order to add the server certificate of your Crowd server to the truststore, go to 'SSL Certificates', located 
under 'Security' in the 'Administration' menu. In the 'SSL Certificates' panel click the 'Load Certificate' 
button, which prompts a dropdown menu with two options:

* 'Load from server': where you can enter the full +https://+ URL from the Crowd server
* 'Paste PEM': where you can enter an encoded, remote certificate generated from Crowd

NOTE: Read more about centralizing <<ssl-certificates,ssl certificates>> to the {nxrm} in the Security chapter.

[[crowd-sect-mapping]]
=== Configure {pro} Crowd Security

There are two approaches available to manage what privileges a Crowd user has when they login to {pro}. You can 
map Crowd groups to roles or map Crowd users to roles.

TIP: Mapping Crowd groups to {pro} roles is preferred because there is less configuration involved overall in
{pro} and assigning users to Crowd groups can be centrally managed inside of Crowd by your security team after the
initial repository manager setup.

[[crowd-sect-mapping-group]]
==== Mapping a Crowd Group to Roles

When mapping a Crowd group to a {pro} role, you are specifying the permissions (via roles) that users within the
Crowd group will have after they authenticate.

To map a Crowd group to a {pro} role, open the 'Roles' panel by clicking on the 'Roles' link under 'Security'
in the 'Administration' panel. Click on 'Create role' button, select 'External Role Mapping', then click 'Crowd'. 
This will take you 'Create Role' panel, as mentioned in <<roles>>.

After choosing the 'Crowd' realm, the 'Role' drop-down should list all the Crowd groups to which the Crowd 
application has access. Select the group you would like to map in the 'Role' field.

TIP: If you have two or more groups in a Crowd application with identical names but in different directories, 
the repository manager will only list the first one that Crowd finds. Therefore, Crowd administrators should 
avoid identically named groups in Crowd directories.

Before you save, you must add at least one {pro} role or privilege to the mapped group. After you
have added the roles using the 'Add' button, click the 'Save' button.

Saved mappings will appear in the list of roles with a mapping value of 'Crowd'.

[[crowd-sect-mapping-user]]
==== Mapping a Crowd User to Roles

Consider the Crowd server user with an id of +johnsmith+. In the Crowd administrative interface, the +johnsmith+ 
Crowd realm user as a member of both 'dev' and 'crowd-administrators' groups, as shown in
<<fig-crowd-view-user-groups>>.

[[fig-crowd-view-user-groups]]
.Crowd Groups for User "johnsmith"
image::figs/web/crowd-view-user-groups.png[scale=45]

To add an external user go to the 'Administration' menu in the repository manager, then click 'Users' in the 
'Security' section.

Click the 'Source' dropdown button and select 'Crowd'. To search for users from the Crowd realm you can either 
enter an individual username within the filter box, or click the magnifying glass icon to generate the list of 
all users from the Crowd realm.

When the name you entered appears, click on the row of the name you desire to create the mapping for. This will 
take you to a form where you can assign available roles. You must map at least one role to the Crowd managed user 
in order to 'Save'.
