[[crowd]]
== Atlassian Crowd Support

{inrmonly}

https://www.atlassian.com/software/crowd[Atlassian Crowd] is a single sign-on and identity management product that
many organizations use to consolidate user accounts and control which users and groups have access to which
applications. Atlassian Crowd support is an feature preinstalled and ready to configure in {pro}. {nxrm} contains 
a security realm that allows you to configure the repository manager to authenticate
against an Atlassian Crowd instance.

WARNING: *Using LDAP and Crowd Realms together in the repository manager may work, but this is not supported.* If
you already use LDAP support, we recommend adding your LDAP server as a Crowd directory accessible to the Crowd
'nexus' application instead of using both LDAP and Crowd realms in the repository manager.

[[crowd-application-prepare]]
=== Prepare Atlassian Crowd

[[crowd-compatibility]]
==== Compatibility

Always use the latest version of Crowd available at the time your version of {pro} was installed or upgraded. 
If upgrading to a newer Crowd server, carefully review the Crowd server release notes for REST API backwards 
compatibility issues.

Crowd support in {pro} and greater only works in Crowd versions that support the Crowd REST API. Older versions 
use a deprecated SOAP-based API and are less reliable and performant.

Crowd support is actively tested with the highest available version of Crowd at the time {pro} is released.

[[crowd-setup]]
==== Add New Application to the Atlassian Crowd Server

NOTE: These instructions are a general guide to adding an application to Crowd. For current detailed 
instructions, visit the https://confluence.atlassian.com/display/CROWD/Adding+an+Application[official
Crowd documentation].

To connect {pro} to Crowd, you will need to configure {pro} as an application in Crowd.

* Login to Crowd as a user with administrative rights.
* Click on the 'Applications' tab.
* Click 'Add application' to display a form, shown in <<fig-crowd-add-application>>

Next, create the new application with the following values in the 'Details' section:

* Application Type: Generic Application

* Name: demo

* Description: (optional)

Choose a password for the application. The repository manager will use this password to authenticate with the 
Crowd server. Confirm the password, then click the 'Next' button.

[[fig-crowd-add-application]]
.Adding a New Crowd Application
image::figs/web/crowd-add-application.png[scale=50]

Click 'Next' to advance to the 'Connection' breadcrumb. On this screen you need to supply the URL of your 
application instance and the remote IP address for {pro}. The form shows the 'Connection' configured for a local 
instance of {pro}. If you were configuring Crowd and {pro} in a production environment, you would supply the URL 
that users would use to load the repository manager user interface in a web browser and you would supply the IP 
address that the repository manager will be connecting from.  Once you have completed the 
'Connection' form, click on 'Next' to advance to the 'Directories' form.

The 'Directories' form allows you to select the user directory used for authentication.

Clicking on the 'Next' button in the 'Directories' form advances to the 'Authorisation' form. If any of the 
directories selected in the previous form contain groups, each group is displayed on this form next to a 
checkbox. You can select 'Allow all users' for a directory or you can select specific groups that are allowed to 
authenticate to {pro} via Crowd. This option would be used if you wanted to limit repository manager access to 
specific subgroups within a larger Crowd directory. If your entire organization is stored in a single Crowd 
directory, you may want to limit repository manager access to a group that contains only developers and 
administrators.

[[crowd-configuration]]
=== Configure {pro} Crowd Integration


[[crowd-ssl]]
==== Configure {pro} to Trust Crowdâ€™s Secure URL (Optional)

Although optional, we advise the connection from {pro} to your Crowd server to use the HTTPS protocol.

If the Crowd Server certificate is not signed by a public certificate authority, you may have to explicitly trust
the server certificate using <<ssl,SSL support>>. A common symptom observed are +peer not authenticated+
messages, when trying to connect to the Crowd server.

Steps to explicitly trust the Crowd Server URL certificate in {pro} are:

. <<crowd-capability,Enable the Crowd Capability>>
. <<crowd-ssl-trust,Add the Crowd server certificate to the truststore>>
. <<crowd-config-connection,Configure Crowd Connection URL using
the HTTPS url>>

[[crowd-capability]]
===== Enable the Crowd Capability

To enable 'Crowd' go to 'Capabilities' located under 'System' in the 'Administration' menu. Perform the following 
steps:

. click the 'Create capability' button to get to the 'Select Capability Type' table
. select 'Capabilities' to open the 'Capabilities' panel located in the 'Administration' menu
. select 'Crowd' to open the 'Create Crowd Capability' panel
. Click the 'Add' button in the panel toolbar. Select 'SSL: Crowd' in the 'Type' field. Make sure the 'Enabled' 
checkbox is checked, and click the 'Save' button.

[[crowd-ssl-trust]]
===== Adding the Crowd Server Certificate to the Truststore

In order to add the server certificate of your Crowd server to the truststore, go to 'SSL Certificates', located 
under 'Security' in the 'Administration' menu. In the 'SSL Certificates' panel click the 'Load Certificate' 
button, prompts a dropdown menu with two options:

. 'Load from server', where you can enter the full +https://+ URL from the Crowd server
. 'Paste PEM', where you can enter an encoded, remote certificate generated from Crowd

NOTE: Read more about centralizing <<ssl-certificates,ssl certificates>> to the {nxrm} in the Security chapter.

[[crowd-config-connection]]
==== Configure Nexus Crowd Connection

The Crowd Configuration screen displayed in <<fig-manage-crowd-config>> can be accessed by users with 
administrative privileges in {pro} by selecting 'Atlassian Crowd' in the 'Security' section of the 
'Administration' menu.

From this screen you can access your Crowd roles through a running instance of {nxrm}. To manage a Crowd 
server connection within the repository manager you can activate the following:

. Check the 'Enable Crowd' box to activate the capability
. Check 'Enable Crowd Realm for Authentication' to allow prioritization of you available security realms

[[fig-manage-crowd-config]]
.Crowd Configuration Panel
image::figs/web/manage-crowd-config.png[scale=50]

This panel contains the following fields:

Application Name:: This field contains the application name of a Crowd application. This value should match the 
value in the Name field of the form.

Application Password:: This field contains the application password of a Crowd application. This value should 
match the value in the Password field of the form.

Crowd Server URL:: This is the URL used to connect to the Crowd Server.  Both 'http://' and 'https://' URLs are 
accepted. You may need to <<crowd-ssl-trust,trust the crowd server certificate>> if a 'https://' URL is used.

HTTP Timeout:: The HTTP Timeout specifies the number of milliseconds the repository manager will wait for a
response from Crowd. A value of zero indicates that there is no timeout limit. Leave the field blank to use the
default HTTP timeout.

You can use the 'Verify Connection' button to validate if your connection to Crowd is working. Once you have a 
working connection, press 'Save' to confirm the configuration. Use 'Cancel' to abort saving any changes.

[[crowd-sect-mapping]]
=== Configure {pro} Crowd Security

There are two approaches available to manage what privileges a Crowd user has when they login to {pro}.

. Mapping Crowd Groups to Roles
. Mapping Crowd Users to Roles

NOTE: Mapping Crowd Groups to {pro} Roles is preferable because there is less configuration is involved overall in
{pro} and assigning users to Crowd groups can be centrally managed inside of Crowd by your security team after the
initial repository manager setup.

[[crowd-sect-mapping-group]]
==== Mapping a Crowd Group to Roles

When mapping a Crowd group to a {pro} role, you are specifying the permissions ( via roles ) that users within the
Crowd group will have after they authenticate.

To map a Crowd group to a {pro} role, open the 'Roles' panel by clicking on the 'Roles' link under 'Security'
in the 'Administration panel. Click on 'Create role' button, select 'External Role Mapping', then click 'Crowd'. 
This will take you 'Create Role' panel, as mentioned in <<roles>>.

After choosing the 'Crowd' realm, the 'Role' drop-down should list all the Crowd groups the 'demo' Crowd 
application has access to. Select the group you would like to map in the 'Role' field and click 'Create Mapping'.

NOTE: If you have two or more groups in Crowd accessible to the 'demo' application with the same name but in
different directories, the repository manager will only list the first one that Crowd finds. Therefore, Crowd
administrators should avoid identically named groups in Crowd directories.

Before saving the group-to-role mapping, *you 'must' add at least one {pro} role to the mapped group*. After you
have added the roles using the 'Add' button, click the 'Save' button.

Saved mappings will appear in the list of roles with a mapping value of 'Crowd'.

[[crowd-sect-mapping-user]]
==== Mapping a Crowd User to Roles

Consider the Crowd server user with an id of +johnsmith+. In the Crowd administrative interface, the 
user is a member of the +dev+ group, as shown in <<fig-crowd-view-user-groups>>.

[[fig-crowd-view-user-groups]]
.Crowd Groups for User "johnsmith"
image::figs/web/crowd-view-user-groups.png[scale=45]

To add an external user, open the 'Users' panel in the repository manager by clicking 'Users' in the 'Security' 
section of the sidebar menu.

Click the 'Source' dropdown button and select 'Crowd'. This action will display a table where you can locate a 
user by Crowd user ID.

Typing the Crowd user id - for example +johnsmith+ - into the 'ID' field and clicking the magnifying 
glass icon, will prompt the repository manager to search for a user ID +johnsmith+ from the Crowd realm.

When the name you entered appears, click the ID to grant roles to the Crowd user. This will take you 
to a form where you can assign available roles. *You must map at least one role
to the Crowd managed user* in order to 'Save'. The external Crowd User Example displays the s+johnsmith+
Crowd realm user as a member of the 'dev' Crowd group and the mapped role called 'Nexus Administrator Role'. 
External groups like +dev+ are bolded in the 'Roles' table.

[[crowd-realm]]
=== Activate {pro} Crowd Realm

The final step to allow Crowd users to authenticate against {pro} is to activate the Crowd authorization realm 
from the 'Security' menu. Do the following:

. Select 'Realms' from the 'Administration' sidebar menu.
. Drag 'Crowd Realm' from the list of 'Available' realms to the end of the 'Active' realms list.
. 'Save' the server settings.
